<%+header%>

<style type="text/css">
    .speedtest-container {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
    }

    .speedtest-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .speedtest-button {
        background-color: #0069d9;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 16px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .speedtest-button:hover {
        background-color: #0051a8;
    }

    .speedtest-button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }

    .status-container {
        text-align: center;
        padding: 30px 0;
        display: none;
    }

    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #0069d9;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .results-container {
        display: none;
    }

    .result-cards {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 10px;
    }

    .result-card {
        flex: 1;
        min-width: 150px;
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 15px;
        text-align: center;
    }

    .result-value {
        font-size: 24px;
        font-weight: bold;
        color: #0069d9;
        margin: 10px 0;
    }

    .result-label {
        font-size: 14px;
        color: #6c757d;
    }

    @media (max-width: 768px) {
        .result-cards {
            flex-direction: column;
        }
    }
</style>

<div class="cbi-map">
    <h2 name="content"><%:Network Speed Test%></h2>

    <div class="speedtest-container">
        <div class="speedtest-header">
            <h3><%:Test your connection speed%></h3>
            <button id="start-test" class="speedtest-button"><%:Start Speed Test%></button>
        </div>

        <div id="test-status" class="status-container">
            <div class="spinner"></div>
            <p><%:Running speed test. This may take up to 60 seconds...%></p>
        </div>

        <div id="results" class="results-container">
            <h3><%:Test Results%></h3>
            <div class="result-cards">
                <div class="result-card">
                    <div class="result-label"><%:Download Speed%></div>
                    <div class="result-value"><span id="download">-</span> <span class="unit">Mbps</span></div>
                </div>
                <div class="result-card">
                    <div class="result-label"><%:Upload Speed%></div>
                    <div class="result-value"><span id="upload">-</span> <span class="unit">Mbps</span></div>
                </div>
                <div class="result-card">
                    <div class="result-label"><%:Ping Latency%></div>
                    <div class="result-value"><span id="ping">-</span> <span class="unit">ms</span></div>
                </div>
            </div>
            <div id="warning-message" style="color: #e74c3c; margin-top: 15px; display: none;"></div>
        </div>
    </div>
</div>

<script type="text/javascript">
    document.getElementById('start-test').addEventListener('click', function () {
        var statusDiv = document.getElementById('test-status');
        var resultsDiv = document.getElementById('results');
        var startButton = document.getElementById('start-test');
        var warningMessage = document.getElementById('warning-message');

        statusDiv.style.display = 'block';
        resultsDiv.style.display = 'none';
        warningMessage.style.display = 'none';
        startButton.disabled = true;

        // Start the test
        fetch('/cgi-bin/luci/admin/router-ease/action_run_speedtest', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
            .then(response => response.json())
            .then(() => {
                // Poll for results
                var checkStatus = setInterval(function () {
                    fetch('cgi-bin/luci/admin/router-ease/action_status')
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'complete') {
                                clearInterval(checkStatus);
                                statusDiv.style.display = 'none';
                                resultsDiv.style.display = 'block';
                                startButton.disabled = false;

                                // Update results
                                document.getElementById('ping').textContent =
                                    ((data.data.ping || {}).median || 0).toFixed(1);
                                document.getElementById('download').textContent =
                                    ((data.data.download || {}).bps_mean / 1000000 || 0).toFixed(2);
                                document.getElementById('upload').textContent =
                                    ((data.data.upload || {}).bps_mean / 1000000 || 0).toFixed(2);

                                if (data.warning) {
                                    warningMessage.textContent = data.warning;
                                    warningMessage.style.display = 'block';
                                }
                            } else if (data.status === 'error') {
                                clearInterval(checkStatus);
                                statusDiv.style.display = 'none';
                                startButton.disabled = false;
                                alert('Error running speed test: ' + data.message);
                            }
                        })
                        .catch(error => {
                            clearInterval(checkStatus);
                            statusDiv.style.display = 'none';
                            startButton.disabled = false;
                            console.error('Error checking status:', error);
                        });
                }, 2000);
            })
            .catch(error => {
                statusDiv.style.display = 'none';
                startButton.disabled = false;
                console.error('Error starting test:', error);
            });
    });
</script>

<%+footer%>